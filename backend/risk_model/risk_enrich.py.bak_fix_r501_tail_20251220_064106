from __future__ import annotations

from typing import Any
from pathlib import Path
import json


_ALIASES_CACHE: dict[str, str] | None = None


def _load_account_aliases() -> dict[str, str]:
    """
    Optional manual mapping file:
      risk_model/account_aliases.json
    Format: { "102.504": "HALKBANK ...", ... }
    """
    global _ALIASES_CACHE
    if _ALIASES_CACHE is not None:
        return _ALIASES_CACHE

    p = Path(__file__).with_name("account_aliases.json")
    if not p.exists():
        _ALIASES_CACHE = {}
        return _ALIASES_CACHE

    try:
        data = json.loads(p.read_text(encoding="utf-8"))
        if isinstance(data, dict):
            out: dict[str, str] = {}
            for k, v in data.items():
                if k is None or v is None:
                    continue
                ks = str(k).strip()
                vs = str(v).strip()
                if ks and vs:
                    out[ks] = vs
            _ALIASES_CACHE = out
            return _ALIASES_CACHE
    except Exception:
        pass

    _ALIASES_CACHE = {}
    return _ALIASES_CACHE


def _lookup_account_name(metrics: dict | None, account_code: str) -> str | None:
    """
    Priority:
      1) account_aliases.json (manual)
      2) metrics['mizan']['account_name_map'] / ['account_names'] (from compute_mizan_metrics patch)
      3) best-effort search in other mizan maps if present
    """
    aliases = _load_account_aliases()
    v = aliases.get(account_code)
    if isinstance(v, str) and v.strip():
        return v.strip()

    if not metrics or not isinstance(metrics, dict):
        return None

    mizan = metrics.get("mizan")
    if not isinstance(mizan, dict):
        return None

    # Direct maps expected after patch
    for map_key in ("account_name_map", "account_names"):
        mp = mizan.get(map_key)
        if isinstance(mp, dict):
            vv = mp.get(account_code)
            if isinstance(vv, str) and vv.strip():
                return vv.strip()

    # Fallback known keys
    for k in (
        "account_titles", "hesap_adlari", "hesap_adi_map",
        "accounts_by_code", "account_map", "hesap_map"
    ):
        mp = mizan.get(k)
        if isinstance(mp, dict):
            vv = mp.get(account_code)
            if isinstance(vv, str) and vv.strip():
                return vv.strip()
            if isinstance(vv, dict):
                for kk in ("name", "title", "hesap_adi", "account_name"):
                    vvv = vv.get(kk)
                    if isinstance(vvv, str) and vvv.strip():
                        return vvv.strip()

    return None


def _extract_kdv_matrah_by_month(metrics: dict | None) -> dict[str, float] | None:
    """
    Extract KDV matrah by month from metrics['beyanname'].
    Expected shape:
      beyanname.per_type.KDV.per_period['YYYY-MM'].matrah_toplami
    """
    if not metrics or not isinstance(metrics, dict):
        return None

    b = metrics.get("beyanname")
    if not isinstance(b, dict):
        return None

    per_type = b.get("per_type")
    if not isinstance(per_type, dict):
        return None

    kdv = per_type.get("KDV")
    if not isinstance(kdv, dict):
        return None

    per_period = kdv.get("per_period")
    if not isinstance(per_period, dict):
        return None

    out: dict[str, float] = {}
    for ym, rec in per_period.items():
        if not isinstance(rec, dict):
            continue
        if "matrah_toplami" in rec:
            try:
                out[str(ym)] = float(rec["matrah_toplami"] or 0.0)
            except Exception:
                continue

    return out or None


def _fmt_try(x: Any) -> Any:
    try:
        return float(x)
    except Exception:
        return x


def _enrich_r401a(risk: dict, metrics: dict | None, period: str | None) -> None:
    risk.setdefault("title", "Mizan 102 Alt Hesap Var, Banka Ekstresi Yok")

    vf = risk.get("value_found") or {}
    if isinstance(vf, dict):
        missing = vf.get("missing_102")
        if isinstance(missing, dict):
            details: list[dict[str, Any]] = []
            for acc, amt in missing.items():
                acc_s = str(acc)
                name = _lookup_account_name(metrics, acc_s)
                details.append({"account_code": acc_s, "account_name": name, "amount": _fmt_try(amt)})
            details.sort(key=lambda x: x.get("account_code") or "")
            vf.setdefault("missing_102_details", details)
            risk["value_found"] = vf

    risk.setdefault(
        "smmm_actions",
        [
            "Eksik görünen 102.xx hesabın bankadaki karşılığını (IBAN/hesap no) doğrulayın.",
            "2025-Q2 (Nisan–Haziran) dönemine ait tüm ekstre dosyalarının sisteme yüklendiğini kontrol edin.",
            "Hesap vadeli/bloke/POS/teminat vb. bir ürünse, hareketlerin farklı raporlarda tutulup tutulmadığını teyit edin (POS raporu, bloke hesap ekstresi, sanal POS).",
            "Mizan kaydı doğruysa bankadan ilgili döneme ait resmi ekstreyi temin edip sisteme ekleyin ve modeli yeniden çalıştırın.",
        ],
    )

    risk.setdefault(
        "checklist",
        [
            "2025-Q2 için banka klasöründe ilgili bankaya ait tüm CSV/XLSX ekstreler var mı?",
            "Aynı bankada birden fazla hesap/IBAN var mı (alt hesaplar farklı IBAN’lara bağlı olabilir)?",
            "Tarih parse/format nedeniyle satırlar ‘dönem dışı’ kalmış olabilir mi (özellikle gün/ay yer değişimi)?",
            "102.xx alt hesap adı POS/bloke/vadeli gibi ürünleri işaret ediyor mu?",
            "Eksik ekstre eklendikten sonra: yeniden çalıştır ve R-401A’nın kaybolduğunu doğrula.",
        ],
    )

    ed = risk.setdefault("evidence_details", {})
    if isinstance(ed, dict):
        ed.setdefault("period", period)
        ed.setdefault("rule_logic", "Mizan 102.xx var AND bankada ilgili dönemde hesap hareketi yok → missing_102")
        ed.setdefault(
            "note",
            "Bu durum tek başına 'usulsüzlük' değildir. 102.xx alt hesabın hangi banka/hesap olduğuna göre ekstre yüklenmeli veya alt hesap sınıflaması gözden geçirilmeli.",
        )
def _enrich_r501(risk: dict, metrics: dict | None, period: str | None) -> None:
    """
    R-501 enrichment (VDK-grade, metrics-driven, boş kalmaz):
    - KDV matrah ay kırılımını metrics->beyanname'den üretir
    - e-defter satış delilini metrics->edefter->sales_evidence'tan alır
    - audit_pack: month_table + worst_month + worst_month_details + samples
    """
    from typing import Any

    def to_float_any(x: Any) -> float:
        if isinstance(x, (int, float)):
            return float(x)
        s = str(x or "").strip()
        if not s:
            return 0.0
        s = s.replace(" ", "")
        try:
            # TR: 1.234,56 -> 1234.56 ; 1234,56 -> 1234.56
            if "," in s:
                if "." in s:
                    s = s.replace(".", "").replace(",", ".")
                else:
                    s = s.replace(",", ".")
            return float(s)
        except Exception:
            return 0.0

    def months_for_period(per: str | None) -> list[str]:
        # "2025-Q2" -> ["2025-04","2025-05","2025-06"]
        if not per or "-Q" not in per:
            return []
        y, q = per.split("-Q", 1)
        try:
            y = int(y); q = int(q)
        except Exception:
            return []
        start_m = (q - 1) * 3 + 1
        return [f"{y:04d}-{m:02d}" for m in (start_m, start_m+1, start_m+2)]

    risk.setdefault("title", "KDV Matrahı - Satışlar Uyumsuzluğu")
    ed = risk.get("evidence_details")
    if not isinstance(ed, dict):
        ed = {}
        risk["evidence_details"] = ed

    ed.setdefault("period", period)
    ed.setdefault("comparison", "KDV Matrahı (beyanname) ↔ Brüt/Net Satışlar (mizan/e-defter)")
    ed.setdefault("mizan_sales_accounts", ["600", "601", "602"])
    ed.setdefault("rule_logic", "KDV matrah toplamı ≠ (600/601/602) satış referansı → sapma analizi")

    warnings: list[str] = []

    metrics = metrics if isinstance(metrics, dict) else {}

    # 1) KDV matrah ay kırılımı (beyanname)
    kdv_by: dict[str, float] = {}
    kdv_per = (((metrics.get("beyanname") or {}).get("per_type") or {}).get("KDV") or {}).get("per_period") or {}
    if isinstance(kdv_per, dict) and period:
        want = set(months_for_period(period)) or set(kdv_per.keys())
        for mm, obj in kdv_per.items():
            if mm not in want:
                continue
            if isinstance(obj, dict):
                kdv_by[mm] = to_float_any(obj.get("matrah_toplami"))
    if not kdv_by:
        # fallback: evidence_details'ta varsa kullan
        if isinstance(ed.get("kdv_matrah_by_month"), dict):
            for mm,v in (ed.get("kdv_matrah_by_month") or {}).items():
                kdv_by[mm] = to_float_any(v)
    if not kdv_by:
        warnings.append("kdv_matrah_by_month üretilemedi (beyanname verisi yok/uyumsuz).")

    # 2) e-defter satış delili (metrics->edefter->sales_evidence)
    se = ((metrics.get("edefter") or {}).get("sales_evidence") or {})
    if not isinstance(se, dict):
        se = {}
    per_month_net = se.get("per_month_net_sales") if isinstance(se.get("per_month_net_sales"), dict) else {}
    per_month_sales = se.get("per_month_sales_600_601_602") if isinstance(se.get("per_month_sales_600_601_602"), dict) else {}
    per_month_disc = se.get("per_month_discounts_610_611_612") if isinstance(se.get("per_month_discounts_610_611_612"), dict) else {}
    samples_sales = se.get("samples_sales_by_month") if isinstance(se.get("samples_sales_by_month"), dict) else {}
    samples_kdv = se.get("samples_kdv_by_month") if isinstance(se.get("samples_kdv_by_month"), dict) else {}

    if not per_month_net and not per_month_sales:
        # fallback: evidence_details'ta varsa kullan
        se2 = ed.get("edefter_sales_evidence") if isinstance(ed.get("edefter_sales_evidence"), dict) else {}
        per_month_net = se2.get("per_month_net_sales") if isinstance(se2.get("per_month_net_sales"), dict) else {}
        per_month_sales = se2.get("per_month_sales_600_601_602") if isinstance(se2.get("per_month_sales_600_601_602"), dict) else {}
        per_month_disc = se2.get("per_month_discounts_610_611_612") if isinstance(se2.get("per_month_discounts_610_611_612"), dict) else {}
        samples_sales = se2.get("samples_sales_by_month") if isinstance(se2.get("samples_sales_by_month"), dict) else {}
        samples_kdv = se2.get("samples_kdv_by_month") if isinstance(se2.get("samples_kdv_by_month"), dict) else {}

    if not per_month_net and not per_month_sales:
        warnings.append("edefter satış delili üretilemedi (metrics->edefter->sales_evidence boş).")

    # evidence_details’a “kanıt seti” olarak ekle (rapor katmanı için)
    if kdv_by:
        ed["kdv_matrah_by_month"] = {k: float(v) for k,v in kdv_by.items()}
    if isinstance(se, dict) and se:
        ed["edefter_sales_evidence"] = se

    # 3) audit_pack (ay tablosu + worst_month + samples)
    months = sorted(set(list(kdv_by.keys()) + list(per_month_net.keys()) + list(per_month_sales.keys()) + list(per_month_disc.keys())))
    month_table = []
    worst = None  # (abs_delta, month)

    for m in months:
        kdv = to_float_any(kdv_by.get(m))
        net = to_float_any(per_month_net.get(m))
        if net == 0.0 and per_month_sales:
            # net yoksa satış - iskonto ile üret
            net = to_float_any(per_month_sales.get(m)) - to_float_any(per_month_disc.get(m))
        delta = net - kdv
        month_table.append({
            "month": m,
            "kdv_matrah": kdv,
            "edefter_net_sales": net,
            "delta_net_minus_kdv": delta,
        })
        ad = abs(delta)
        if worst is None or ad > worst[0]:
            worst = (ad, m)

    worst_month = worst[1] if worst else (months[-1] if months else None)

    worst_details = None
    if worst_month:
        kdv = to_float_any(kdv_by.get(worst_month))
        sales = to_float_any(per_month_sales.get(worst_month))
        disc = to_float_any(per_month_disc.get(worst_month))
        net = to_float_any(per_month_net.get(worst_month))
        if net == 0.0 and (sales or disc):
            net = sales - disc
        worst_details = {
            "kdv_matrah": kdv,
            "edefter_sales_600_601_602": sales,
            "edefter_discounts_610_611_612": disc,
            "edefter_net_sales": net,
            "delta_net_minus_kdv": net - kdv,
            "samples_sales": (samples_sales.get(worst_month) or []) if isinstance(samples_sales.get(worst_month), list) else [],
            "samples_kdv": (samples_kdv.get(worst_month) or []) if isinstance(samples_kdv.get(worst_month), list) else [],
            "note": "Örnek satırlar delil seçimi içindir; nihai doğrulama yevmiye/fatura ile yapılmalıdır.",
        }

    ed["audit_pack"] = {
        "period": period,
        "worst_month": worst_month,
        "month_table": month_table,
        "note": "Ay bazında e-defter net satış - KDV matrah farkı; delil seçimi ve açıklama hazırlığı için yön verir.",
        "worst_month_details": worst_details,
    }

    if warnings:
        ed["enrich_warnings"] = warnings
    else:
        ed.pop("enrich_warnings", None)

    def to_float_any(x: Any) -> float:
        # numeric ise direkt
        if isinstance(x, (int, float)):
            return float(x)
        s = str(x or "").strip()
        if not s:
            return 0.0
        s = s.replace(" ", "")
        # TR/EN ayrımı:
        # - "1.234,56" => 1234.56 (TR)
        # - "1234,56"  => 1234.56 (TR)
        # - "1234.56"  => 1234.56 (EN)
        try:
            if "," in s:
                if "." in s:
                    s = s.replace(".", "").replace(",", ".")
                else:
                    s = s.replace(",", ".")
            # comma yoksa '.' decimal kabul
            return float(s)
        except Exception:
            return 0.0

    ed = risk.get("evidence_details")
    if not isinstance(ed, dict):
        ed = {}
        risk["evidence_details"] = ed

    enrich_warnings: list[str] = []

    # 1) KDV matrah ay kırılımı
    kdv_by = ed.get("kdv_matrah_by_month")
    if not isinstance(kdv_by, dict):
        # bazı akışlarda önceki patchler kdv_by_month’u koymamış olabilir
        enrich_warnings.append("kdv_matrah_by_month missing; audit_pack month table limited.")
        kdv_by = {}

    # 2) e-defter satış delili (ay bazında)
    se = ed.get("edefter_sales_evidence")
    if not isinstance(se, dict):
        enrich_warnings.append("edefter_sales_evidence missing; audit_pack month table limited.")
        se = {}

    net_by = se.get("per_month_net_sales") if isinstance(se.get("per_month_net_sales"), dict) else {}
    sales_by = se.get("per_month_sales_600_601_602") if isinstance(se.get("per_month_sales_600_601_602"), dict) else {}
    disc_by = se.get("per_month_discounts_610_611_612") if isinstance(se.get("per_month_discounts_610_611_612"), dict) else {}

    samples_sales = se.get("samples_sales_by_month") if isinstance(se.get("samples_sales_by_month"), dict) else {}
    samples_kdv = se.get("samples_kdv_by_month") if isinstance(se.get("samples_kdv_by_month"), dict) else {}

    # 3) Ay tablosu
    months = sorted(set(list(kdv_by.keys()) + list(net_by.keys()) + list(sales_by.keys()) + list(disc_by.keys())))
    month_table: list[dict[str, Any]] = []

    worst = None  # (abs_delta, month)
    for m in months:
        kdv = to_float_any(kdv_by.get(m))
        net = to_float_any(net_by.get(m))
        delta = net - kdv
        row = {
            "month": m,
            "kdv_matrah": kdv,
            "edefter_net_sales": net,
            "delta_net_minus_kdv": delta,
        }
        month_table.append(row)
        ad = abs(delta)
        if worst is None or ad > worst[0]:
            worst = (ad, m)

    worst_month = worst[1] if worst else (months[-1] if months else None)

    # 4) worst_month detayları (+ samples)
    worst_details = None
    if worst_month:
        kdv = to_float_any(kdv_by.get(worst_month))
        sales = to_float_any(sales_by.get(worst_month))
        disc = to_float_any(disc_by.get(worst_month))
        net = to_float_any(net_by.get(worst_month))
        worst_details = {
            "kdv_matrah": kdv,
            "edefter_sales_600_601_602": sales,
            "edefter_discounts_610_611_612": disc,
            "edefter_net_sales": net,
            "delta_net_minus_kdv": net - kdv,
            "samples_sales": (samples_sales.get(worst_month) or []) if isinstance(samples_sales.get(worst_month), list) else [],
            "samples_kdv": (samples_kdv.get(worst_month) or []) if isinstance(samples_kdv.get(worst_month), list) else [],
            "note": "Örnek satırlar delil seçimi içindir; nihai doğrulama için yevmiye/fatura ile çapraz kontrol önerilir.",
        }

    # 5) audit_pack yaz
    ed["audit_pack"] = {
        "period": period,
        "worst_month": worst_month,
        "month_table": month_table,
        "note": "Ay bazında e-defter net satış - KDV matrah farkı; delil seçimi ve açıklama hazırlığı için yön verir.",
        "worst_month_details": worst_details,
    }

    # 6) uyarılar
    if enrich_warnings:
        ed["enrich_warnings"] = enrich_warnings
    else:
        # eski warning kaldıysa temizle
        if "enrich_warnings" in ed:
            ed.pop("enrich_warnings", None)


def enrich_rules_in_metrics(metrics: dict, period: str | None = None) -> None:
    """
    Enriches metrics['rules']['risks'] in-place.
    """
    if not isinstance(metrics, dict):
        return
    rules = metrics.get("rules")
    if not isinstance(rules, dict):
        return
    risks = rules.get("risks")
    if not isinstance(risks, list):
        return

    for r in risks:
        if not isinstance(r, dict):
            continue
        code = r.get("code")
        if code == "R-401A":
            _enrich_r401a(r, metrics=metrics, period=period)
        elif code == "R-501":
            _enrich_r501(r, metrics=metrics, period=period)
