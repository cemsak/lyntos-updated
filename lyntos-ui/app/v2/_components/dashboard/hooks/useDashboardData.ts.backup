/**
 * useDashboardData - Centralized data fetching hook for dashboard
 * Returns PanelEnvelope objects for each data section
 */

'use client';

import { useState, useEffect, useCallback } from 'react';
import { useDashboardScope } from '../../scope/useDashboardScope';
import type {
  PanelEnvelope,
  KpiStripData,
  TaxAnalysisData,
  MizanData,
  CrossCheckData,
  RegWatchData,
} from '../types';
import {
  createLoadingEnvelope,
  createOkEnvelope,
  createErrorEnvelope,
  createEmptyEnvelope,
  createAuthEnvelope,
} from '../types';

// API base URL
const API_BASE = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://127.0.0.1:8000';

// Auth header for development
const getAuthHeaders = () => ({
  'Authorization': 'Bearer DEV_HKOZKAN',
  'Content-Type': 'application/json',
});

export interface DashboardDataState {
  kpis: PanelEnvelope<KpiStripData>;
  geciciVergi: PanelEnvelope<TaxAnalysisData>;
  kurumlarVergi: PanelEnvelope<TaxAnalysisData>;
  mizan: PanelEnvelope<MizanData>;
  crossCheck: PanelEnvelope<CrossCheckData>;
  regWatch: PanelEnvelope<RegWatchData>;
  refresh: () => void;
  isRefreshing: boolean;
}

// Transform API response to KpiStripData
function transformKpisResponse(data: Record<string, unknown>): KpiStripData {
  const kpis = [
    {
      id: 'cari-bakiye',
      label: 'Cari Bakiye',
      value: formatCurrency(data.cari_bakiye as number),
      status: getStatusFromValue(data.cari_bakiye as number, 0, 10000) as 'success' | 'warning' | 'error',
      trend: { direction: 'up' as const, value: '+2.3%' },
    },
    {
      id: 'kdv-durumu',
      label: 'KDV Durumu',
      value: formatCurrency(data.kdv_durumu as number),
      status: (data.kdv_durumu as number) >= 0 ? 'success' as const : 'error' as const,
    },
    {
      id: 'stopaj',
      label: 'Stopaj',
      value: formatCurrency(data.stopaj as number),
      status: 'info' as const,
    },
    {
      id: 'sgk-prim',
      label: 'SGK Prim',
      value: formatCurrency(data.sgk_prim as number),
      status: 'info' as const,
    },
    {
      id: 'gecici-vergi',
      label: 'Gecici Vergi',
      value: formatCurrency(data.gecici_vergi as number),
      status: 'info' as const,
    },
    {
      id: 'kurumlar-vergi',
      label: 'Kurumlar Vergi',
      value: formatCurrency(data.kurumlar_vergi as number),
      status: 'info' as const,
    },
    {
      id: 'risk-skoru',
      label: 'Risk Skoru',
      value: `${data.risk_skoru || 0}`,
      status: getRiskStatus(data.risk_skoru as number),
      badge: { text: getRiskLabel(data.risk_skoru as number), variant: getRiskStatus(data.risk_skoru as number) },
    },
    {
      id: 'tamamlanma',
      label: 'Tamamlanma',
      value: `%${data.tamamlanma || 0}`,
      status: (data.tamamlanma as number) >= 80 ? 'success' as const : 'warning' as const,
    },
  ];

  return {
    kpis,
    period: (data.period as string) || '',
    lastUpdated: (data.last_updated as string) || new Date().toISOString(),
  };
}

// Transform API response to TaxAnalysisData
function transformTaxAnalysisResponse(data: Record<string, unknown>, period: string): TaxAnalysisData {
  const controls = (data.controls as Array<Record<string, unknown>>) || [];

  return {
    period,
    totalControls: controls.length || (data.total_controls as number) || 0,
    passedControls: (data.passed_controls as number) || controls.filter(c => c.status === 'passed').length,
    warningControls: (data.warning_controls as number) || controls.filter(c => c.status === 'warning').length,
    failedControls: (data.failed_controls as number) || controls.filter(c => c.status === 'failed').length,
    estimatedTax: data.estimated_tax as number,
    controls: controls.map((c, i) => ({
      id: (c.id as string) || `control-${i}`,
      name: (c.name as string) || (c.control_name as string) || `Kontrol ${i + 1}`,
      status: (c.status as 'passed' | 'warning' | 'failed' | 'pending' | 'skipped') || 'pending',
      description: c.description as string,
      value: c.value as string,
    })),
    summary: {
      highRisk: data.high_risk as number,
      mediumRisk: data.medium_risk as number,
      lowRisk: data.low_risk as number,
    },
  };
}

// Helper functions
function formatCurrency(value: number | undefined): string {
  if (value === undefined || value === null) return '0 TL';
  return `${value.toLocaleString('tr-TR')} TL`;
}

function getStatusFromValue(value: number, warningThreshold: number, errorThreshold: number): string {
  if (value >= errorThreshold) return 'error';
  if (value >= warningThreshold) return 'warning';
  return 'success';
}

function getRiskStatus(score: number): 'success' | 'warning' | 'error' {
  if (score >= 70) return 'error';
  if (score >= 40) return 'warning';
  return 'success';
}

function getRiskLabel(score: number): string {
  if (score >= 70) return 'Yuksek';
  if (score >= 40) return 'Orta';
  return 'Dusuk';
}

export function useDashboardData(): DashboardDataState {
  const { scope } = useDashboardScope();
  const clientId = scope.client_id;
  const period = scope.period;
  const [isRefreshing, setIsRefreshing] = useState(false);

  // Individual state for each panel
  const [kpis, setKpis] = useState<PanelEnvelope<KpiStripData>>(createLoadingEnvelope());
  const [geciciVergi, setGeciciVergi] = useState<PanelEnvelope<TaxAnalysisData>>(createLoadingEnvelope());
  const [kurumlarVergi, setKurumlarVergi] = useState<PanelEnvelope<TaxAnalysisData>>(createLoadingEnvelope());
  const [mizan, setMizan] = useState<PanelEnvelope<MizanData>>(createLoadingEnvelope());
  const [crossCheck, setCrossCheck] = useState<PanelEnvelope<CrossCheckData>>(createLoadingEnvelope());
  const [regWatch, setRegWatch] = useState<PanelEnvelope<RegWatchData>>(createLoadingEnvelope());

  // Fetch function for individual endpoints
  const fetchEndpoint = useCallback(async <T>(
    endpoint: string,
    transform: (data: Record<string, unknown>) => T,
    setState: React.Dispatch<React.SetStateAction<PanelEnvelope<T>>>,
    source: string
  ) => {
    try {
      const url = `${API_BASE}${endpoint}`;
      const response = await fetch(url, {
        headers: getAuthHeaders(),
      });

      if (response.status === 401 || response.status === 403) {
        setState(createAuthEnvelope('Yetkilendirme gerekli'));
        return;
      }

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();

      if (!data || (Array.isArray(data) && data.length === 0)) {
        setState(createEmptyEnvelope('Veri bulunamadi'));
        return;
      }

      const transformed = transform(data);
      setState(createOkEnvelope(transformed, source));
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Bilinmeyen hata';
      setState(createErrorEnvelope(message, {
        label: 'Tekrar Dene',
        onClick: () => fetchEndpoint(endpoint, transform, setState, source),
      }));
    }
  }, []);

  // Main fetch function
  const fetchAllData = useCallback(async () => {
    if (!clientId) {
      const authEnvelope = createAuthEnvelope<KpiStripData>('Musteri secilmedi');
      setKpis(authEnvelope);
      setGeciciVergi(createAuthEnvelope('Musteri secilmedi'));
      setKurumlarVergi(createAuthEnvelope('Musteri secilmedi'));
      setMizan(createAuthEnvelope('Musteri secilmedi'));
      setCrossCheck(createAuthEnvelope('Musteri secilmedi'));
      setRegWatch(createAuthEnvelope('Musteri secilmedi'));
      return;
    }

    setIsRefreshing(true);

    // Reset to loading state
    setKpis(createLoadingEnvelope());
    setGeciciVergi(createLoadingEnvelope());
    setKurumlarVergi(createLoadingEnvelope());
    setMizan(createLoadingEnvelope());
    setCrossCheck(createLoadingEnvelope());
    setRegWatch(createLoadingEnvelope());

    // Fetch all endpoints in parallel (fail-soft pattern)
    await Promise.allSettled([
      // KPIs
      fetchEndpoint(
        `/api/v1/dashboard/${clientId}/kpi`,
        transformKpisResponse,
        setKpis,
        'kpi-endpoint'
      ),
      // Gecici Vergi
      fetchEndpoint(
        `/api/v1/tax/${clientId}/gecici?period=${period}`,
        (data) => transformTaxAnalysisResponse(data, period),
        setGeciciVergi,
        'gecici-vergi'
      ),
      // Kurumlar Vergi
      fetchEndpoint(
        `/api/v1/tax/${clientId}/kurumlar?period=${period}`,
        (data) => transformTaxAnalysisResponse(data, period),
        setKurumlarVergi,
        'kurumlar-vergi'
      ),
      // Mizan
      fetchEndpoint(
        `/api/v1/mizan/${clientId}?period=${period}`,
        (data) => data as unknown as MizanData,
        setMizan,
        'mizan'
      ),
      // CrossCheck
      fetchEndpoint(
        `/api/v1/crosscheck/${clientId}?period=${period}`,
        (data) => data as unknown as CrossCheckData,
        setCrossCheck,
        'crosscheck'
      ),
      // RegWatch
      fetchEndpoint(
        `/api/v1/regwatch/latest`,
        (data) => data as unknown as RegWatchData,
        setRegWatch,
        'regwatch'
      ),
    ]);

    setIsRefreshing(false);
  }, [clientId, period, fetchEndpoint]);

  // Initial fetch
  useEffect(() => {
    fetchAllData();
  }, [fetchAllData]);

  return {
    kpis,
    geciciVergi,
    kurumlarVergi,
    mizan,
    crossCheck,
    regWatch,
    refresh: fetchAllData,
    isRefreshing,
  };
}

export default useDashboardData;
